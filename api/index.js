const { Telegraf } = require('telegraf');
const { createClient } = require('@supabase/supabase-js');

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const OWNER_ID = process.env.OWNER_TELEGRAM_ID;
const SUPABASE_URL = process.env.SUPABASE_URL;
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if (!BOT_TOKEN || !OWNER_ID) {
  console.error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –±–æ—Ç–∞');
  process.exit(1);
}

if (!SUPABASE_URL || !SUPABASE_KEY) {
  console.error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Supabase');
  process.exit(1);
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
console.log('SUPABASE_URL –∑–∞–¥–∞–Ω:', !!SUPABASE_URL);
console.log('SUPABASE_KEY –∑–∞–¥–∞–Ω:', !!SUPABASE_KEY);
console.log('SUPABASE_URL –¥–ª–∏–Ω–∞:', SUPABASE_URL ? SUPABASE_URL.length : 0);
console.log('SUPABASE_KEY –¥–ª–∏–Ω–∞:', SUPABASE_KEY ? SUPABASE_KEY.length : 0);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
async function checkTableExists() {
  try {
    console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã qa-bot-messages...');
    const { data, error } = await supabase
      .from('qa-bot-messages')
      .select('id')
      .limit(1);
    
    if (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∞–±–ª–∏—Ü—ã qa-bot-messages:', error);
      // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞
      if (error.code === '42P01') { // –ö–æ–¥ –æ—à–∏–±–∫–∏ PostgreSQL –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã
        console.log('–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É...');
      }
    } else {
      console.log('–¢–∞–±–ª–∏—Ü–∞ qa-bot-messages —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∞–±–ª–∏—Ü—ã:', err);
  }
}

// –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
checkTableExists();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new Telegraf(BOT_TOKEN);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
async function saveMessageToDatabase(userId, userName, userSurname, messageText, timestamp) {
  try {
    console.log('–ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î:', {
      tgid: userId,
      user_name: userName,
      text: messageText.substring(0, 20) + '...' // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ª–æ–≥–æ–≤
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    if (!userId) {
      console.error('userId –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
      return;
    }
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º userId –≤ —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—Ç—Ä–æ–∫–∞
    const tgidValue = userId.toString();
    
    const { data, error } = await supabase
      .from('qa-bot-messages')
      .insert([
        { 
          tgid: tgidValue,
          user_name: userName || null,
          user_surname: userSurname || null,
          text: messageText || '',
          timecode: timestamp
        }
      ]);
    
    if (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë–î:', error);
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      try {
        await bot.telegram.sendMessage(
          OWNER_ID,
          `‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë–î:\n–ö–æ–¥: ${error.code}\n–°–æ–æ–±—â–µ–Ω–∏–µ: ${error.message}\n–î–µ—Ç–∞–ª–∏: ${error.details || '–Ω–µ—Ç'}`
        );
      } catch (e) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤–ª–∞–¥–µ–ª—å—Ü—É:', e);
      }
    } else {
      console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î');
    }
  } catch (err) {
    console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ë–î:', err);
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞
    try {
      await bot.telegram.sendMessage(
        OWNER_ID,
        `üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ë–î: ${err.message}`
      );
    } catch (e) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ –≤–ª–∞–¥–µ–ª—å—Ü—É:', e);
    }
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.start(async (ctx) => {
  const userId = ctx.from.id;
  const userName = ctx.from.first_name;
  const userSurname = ctx.from.last_name;
  const messageText = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞';
  const timestamp = new Date().toISOString();

  // –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  await ctx.reply('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ –º—ã —Å–∫–æ—Ä–æ –Ω–∞ –Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∏–º.');
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü—É
  await bot.telegram.sendMessage(
    OWNER_ID,
    `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID: ${userId}\n–ò–º—è: ${userName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n–§–∞–º–∏–ª–∏—è: ${userSurname || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}\n–î–µ–π—Å—Ç–≤–∏–µ: –ó–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞`
  );

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
  await saveMessageToDatabase(userId, userName, userSurname, messageText, timestamp);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
bot.on('message', async (ctx) => {
  if (ctx.message.text) {
    const userId = ctx.from.id;
    const userName = ctx.from.first_name;
    const userSurname = ctx.from.last_name;
    const messageText = ctx.message.text;
    const timestamp = new Date().toISOString();
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–º –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if (ctx.message.reply_to_message && ctx.from.id.toString() === OWNER_ID) {
      // –ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      const originalMessageText = ctx.message.reply_to_message.text;
      const userIdMatch = originalMessageText.match(/ID: (\d+)/);
      
      if (userIdMatch && userIdMatch[1]) {
        const recipientId = userIdMatch[1];
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await bot.telegram.sendMessage(recipientId, `–û—Ç–≤–µ—Ç: ${messageText}`);
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –ë–î
        await saveMessageToDatabase(OWNER_ID, '–í–ª–∞–¥–µ–ª–µ—Ü', '', `–û—Ç–≤–µ—Ç –¥–ª—è ${recipientId}: ${messageText}`, timestamp);
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É
        await ctx.reply(`–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${recipientId}`);
      } else {
        await ctx.reply('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞');
      }
    } 
    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞)
    else if (ctx.from.id.toString() !== OWNER_ID) {
      // –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      await ctx.reply('–ü–æ–ª—É—á–∏–ª–∏ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏–º');
      
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü—É
      await bot.telegram.sendMessage(
        OWNER_ID,
        `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID: ${userId}\n–ò–º—è: ${userName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n–§–∞–º–∏–ª–∏—è: ${userSurname || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}\n–°–æ–æ–±—â–µ–Ω–∏–µ: ${messageText}`
      );
      
      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
      await saveMessageToDatabase(userId, userName, userSurname, messageText, timestamp);
    }
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.catch((err, ctx) => {
  console.error(`–û—à–∏–±–∫–∞ –¥–ª—è ${ctx.updateType}`, err);
});

// Webhook –¥–ª—è Vercel
module.exports = async (req, res) => {
  try {
    if (req.method === 'POST') {
      await bot.handleUpdate(req.body);
      res.status(200).end();
    } else {
      // –î–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫—É—é-—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
      res.status(200).json({ status: '–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω' });
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞:', error);
    res.status(500).json({ error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
  }
}; 