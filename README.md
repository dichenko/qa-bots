# Telegram Feedback Bot

Телеграм-бот для обратной связи с пользователями. Позволяет получать сообщения от пользователей и отвечать на них. Поддерживает работу с несколькими ботами одновременно.

## Функциональность

1. Пользователь отправляет сообщение в бот
2. Бот отвечает "Получили ваше сообщение, скоро ответим"
3. Владелец бота получает уведомление о новом сообщении с указанием, от какого бота пришло сообщение
4. Владелец может ответить, сделав reply на полученное сообщение
5. Пользователь получает ответ от владельца
6. Все сообщения сохраняются в базе данных Supabase

## Технический стек

- Node.js
- Telegraf.js (библиотека для Telegram Bot API)
- Supabase (база данных)
- Vercel (хостинг)

## Настройка Supabase

1. Создайте новый проект в Supabase
2. Создайте таблицу `qa_bot_messages` со следующей структурой:
   - `id` (serial, primary key)
   - `tgid` (text, not null)
   - `user_name` (text)
   - `user_surname` (text)
   - `text` (text, not null)
   - `timecode` (timestamp, not null)
   - `bot_id` (text, not null)
3. Интегрируйте Supabase с Vercel через маркетплейс Vercel (по желанию)

## Установка и запуск

### Локальная разработка

1. Клонируйте репозиторий
2. Установите зависимости: `npm install`
3. Создайте файл `.env` на основе `.env.example` и заполните его вашими данными
4. Запустите бот локально: `npm run dev`

### Деплой на Vercel

#### Переменные окружения для ботов

Для настройки ботов необходимо добавить переменные окружения с токенами. Поддерживаются следующие форматы переменных:

1. Основной формат (рекомендуется): `TELEGRAM_BOT_TOKEN_<ID_БОТА>`
   ```
   TELEGRAM_BOT_TOKEN_FEELME36=1234567890:ABCDEFGH...
   TELEGRAM_BOT_TOKEN_MYSHADOW=0987654321:ZYXWVUTS...
   ```

2. Альтернативные форматы (для совместимости):
   ```
   TELEGRAM_<ID_БОТА>_BOT_TOKEN=1234567890:ABCDEFGH...
   BOT_TOKEN_<ID_БОТА>=1234567890:ABCDEFGH...
   TELEGRAM_<ID_БОТА>=1234567890:ABCDEFGH...
   ```

3. Для обратной совместимости также поддерживается переменная `TELEGRAM_BOT_TOKEN`.

ID бота - это идентификатор, который используется в URL вебхука и в базе данных. Рекомендуется использовать только латинские буквы, цифры и знак подчеркивания.

#### Вариант 1: С интеграцией Supabase

1. Подключите интеграцию Supabase в маркетплейсе Vercel
2. Создайте новый проект на Vercel и импортируйте репозиторий
3. Добавьте только недостающие переменные окружения в настройках проекта:
   - Для одного бота:
     - `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота
   - Для нескольких ботов:
     - `TELEGRAM_BOT_TOKEN_BOT1` - токен первого бота
     - `TELEGRAM_BOT_TOKEN_BOT2` - токен второго бота
     - и т.д. (формат: `TELEGRAM_BOT_TOKEN_<ID_БОТА>`)
   - `OWNER_TELEGRAM_ID` - ваш Telegram ID
4. Выполните деплой

#### Вариант 2: Без интеграции Supabase

1. Создайте новый проект на Vercel
2. Добавьте следующие переменные окружения в настройках проекта:
   - Для одного бота:
     - `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота
   - Для нескольких ботов:
     - `TELEGRAM_BOT_TOKEN_BOT1` - токен первого бота
     - `TELEGRAM_BOT_TOKEN_BOT2` - токен второго бота
     - и т.д. (формат: `TELEGRAM_BOT_TOKEN_<ID_БОТА>`)
   - `OWNER_TELEGRAM_ID` - ваш Telegram ID
   - `SUPABASE_URL` - URL вашего проекта Supabase
   - `SUPABASE_SERVICE_ROLE_KEY` - сервисный ключ Supabase
3. Выполните деплой

## Настройка вебхуков для Telegram

После деплоя на Vercel, установите вебхуки автоматически,  посетив URL:
```
<VERCEL_URL>/api/setWebhook
```

Это установит вебхуки для всех ботов, указанных в переменных окружения. Каждый бот получит свой уникальный URL в формате:
```
<VERCEL_URL>/api/index/<ID_БОТА>
```

Например, если у вас есть  два бота с ID  `FEELME36` и `MYSHADOW`, вебхуки будут настроены так:
```
<VERCEL_URL>/api/index/FEELME36
<VERCEL_URL>/api/index/MYSHADOW
```

> **Важно**: 
> 1. Каждый бот должен использовать свой уникальный URL с ID бота
> 2. Запросы на путь `/api/index` будут автоматически обрабатываться первым доступным ботом
> 3. Для надежной работы рекомендуется всегда использовать именованные пути с ID бота

## Работа с несколькими ботами

Система поддерживает одновременную работу с несколькими ботами. Каждый бот должен иметь уникальный идентификатор, указанный в имени переменной окружения после префикса `TELEGRAM_BOT_TOKEN_`.

ID бота - это часть имени переменной окружения, идущая после `TELEGRAM_BOT_TOKEN_`. Например:
- Для переменной `TELEGRAM_BOT_TOKEN_FEELME36` ID бота будет `FEELME36`
- Для переменной `TELEGRAM_BOT_TOKEN_MYSHADOW` ID бота будет `MYSHADOW`

Для настройки ботов мы рекомендуем использовать только переменные с префиксом `TELEGRAM_BOT_TOKEN_`. Переменная `TELEGRAM_BOT_TOKEN` поддерживается только для обратной совместимости и не рекомендуется к использованию.

При получении сообщения система автоматически определяет, от какого бота оно пришло, и передает эту информацию владельцу. При ответе владельца система отправляет сообщение через соответствующего бота.

Все сообщения от всех ботов хранятся в одной таблице `qa_bot_messages` и различаются по полю `bot_id`. 