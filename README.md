# Telegram Feedback Bot

Телеграм-бот для обратной связи с пользователями. Позволяет получать сообщения от пользователей и отвечать на них. Поддерживает работу с несколькими ботами одновременно.

## Функциональность

1. Пользователь отправляет сообщение в бот
2. Бот отвечает "Получили ваше сообщение, скоро ответим"
3. Владелец бота получает уведомление о новом сообщении с указанием, от какого бота пришло сообщение
4. Владелец может ответить, сделав reply на полученное сообщение
5. Пользователь получает ответ от владельца
6. Все сообщения сохраняются в базе данных Supabase

## Технический стек

- Node.js
- Telegraf.js (библиотека для Telegram Bot API)
- Supabase (база данных)
- Vercel (хостинг)

## Настройка Supabase

1. Создайте новый проект в Supabase
2. Создайте таблицу `qa_bot_messages` со следующей структурой:
   - `id` (serial, primary key)
   - `tgid` (text, not null)
   - `user_name` (text)
   - `user_surname` (text)
   - `text` (text, not null)
   - `timecode` (timestamp, not null)
   - `bot_id` (text, not null)
3. Интегрируйте Supabase с Vercel через маркетплейс Vercel (по желанию)

## Установка и запуск

### Локальная разработка

1. Клонируйте репозиторий
2. Установите зависимости: `npm install`
3. Создайте файл `.env` на основе `.env.example` и заполните его вашими данными
4. Запустите бот локально: `npm run dev`

### Деплой на Vercel

#### Вариант 1: С интеграцией Supabase

1. Подключите интеграцию Supabase в маркетплейсе Vercel
2. Создайте новый проект на Vercel и импортируйте репозиторий
3. Добавьте только недостающие переменные окружения в настройках проекта:
   - Для одного бота:
     - `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота
   - Для нескольких ботов:
     - `TELEGRAM_BOT_TOKEN_BOT1` - токен первого бота
     - `TELEGRAM_BOT_TOKEN_BOT2` - токен второго бота
     - и т.д. (формат: `TELEGRAM_BOT_TOKEN_<ID_БОТА>`)
   - `OWNER_TELEGRAM_ID` - ваш Telegram ID
4. Выполните деплой

#### Вариант 2: Без интеграции Supabase

1. Создайте новый проект на Vercel
2. Добавьте следующие переменные окружения в настройках проекта:
   - Для одного бота:
     - `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота
   - Для нескольких ботов:
     - `TELEGRAM_BOT_TOKEN_BOT1` - токен первого бота
     - `TELEGRAM_BOT_TOKEN_BOT2` - токен второго бота
     - и т.д. (формат: `TELEGRAM_BOT_TOKEN_<ID_БОТА>`)
   - `OWNER_TELEGRAM_ID` - ваш Telegram ID
   - `SUPABASE_URL` - URL вашего проекта Supabase
   - `SUPABASE_SERVICE_ROLE_KEY` - сервисный ключ Supabase
3. Выполните деплой

## Настройка вебхуков для Telegram

После деплоя на Vercel, установите вебхуки автоматически, посетив URL:
```
<VERCEL_URL>/api/setWebhook
```

Это установит вебхуки для всех ботов, указанных в переменных окружения.

Для каждого бота настраиваются два вебхука:

1. Для первого бота в списке (в алфавитном порядке):
   ```
   <VERCEL_URL>/api/index
   <VERCEL_URL>/api/index/<ID_БОТА>
   ```

2. Для всех остальных ботов:
   ```
   <VERCEL_URL>/api/index/<ID_БОТА>
   ```

Например, если у вас есть два бота с ID `BOT1` и `BOT2`, вебхуки будут настроены так:
```
<VERCEL_URL>/api/index        (для первого бота в алфавитном порядке)
<VERCEL_URL>/api/index/BOT1
<VERCEL_URL>/api/index/BOT2
```

> **Важно**: Запросы на путь `/api/index` всегда обрабатываются первым доступным ботом. Настоятельно рекомендуется всегда использовать именованные пути с ID бота для точной маршрутизации.

## Работа с несколькими ботами

Система поддерживает одновременную работу с несколькими ботами. Каждый бот должен иметь уникальный идентификатор, указанный в имени переменной окружения после префикса `TELEGRAM_BOT_TOKEN_`.

ID бота - это часть имени переменной окружения, идущая после `TELEGRAM_BOT_TOKEN_`. Например, для переменной `TELEGRAM_BOT_TOKEN_FEEDBACK` ID бота будет `FEEDBACK`.

Для настройки ботов мы рекомендуем использовать только переменные с префиксом `TELEGRAM_BOT_TOKEN_`, не полагаясь на переменную `TELEGRAM_BOT_TOKEN`.

При получении сообщения система автоматически определяет, от какого бота оно пришло, и передает эту информацию владельцу. При ответе владельца система отправляет сообщение через соответствующего бота.

Все сообщения от всех ботов хранятся в одной таблице `qa_bot_messages` и различаются по полю `bot_id`. 